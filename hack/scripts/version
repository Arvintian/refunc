#!/bin/bash

export NAMESPACE=${CI_PROJECT_NAMESPACE:="refunc"}

source ./hack/scripts/common

if [ -n "$(git status --porcelain --untracked-files=no)" ]; then
    DIRTY="-dirty"
fi

COMMIT=$(git rev-parse --short HEAD)
GIT_TAG=$(git tag -l --contains HEAD | head -n 1)

if [[ -z "$DIRTY" && -n "$GIT_TAG" ]]; then
    VERSION=$GIT_TAG
    export REFUNC_VERSION=${VERSION}
    export AGENT_VERSION=${VERSION}
    export LOADER_VERSION=${VERSION}
    export SIDECAR_VERSION=${VERSION}
    export CREDSYNCER_VERSION=${VERSION}
else
    _DEPS_VERSION=$(
        echo \
        $(get_version $(find pkg -type f -name '*.go')) \
        $(get_version cmd/refunc/*.go) \
        $(get_version cmd/controller/*.go) \
        $(get_version cmd/play/*.go) \
        $(get_version cmd/triggers/*.go) | my_sha1sum | cut -c 1-8
    )
    export REFUNC_VERSION=${_DEPS_VERSION}${DIRTY}
    export AGENT_VERSION=$(echo $(get_version pkg/runtime/legacy/loader/*.go cmd/agent/*.go package/Dockerfile) | my_sha1sum | cut -c 1-8)${DIRTY}
    export LOADER_VERSION=$(echo $(get_version pkg/runtime/lambda/loader/*.go cmd/loader/*.go package/Dockerfile) | my_sha1sum | cut -c 1-8)${DIRTY}
    export SIDECAR_VERSION=$(echo $(get_version $(find pkg/sidecar -type f -name '*.go') $(find pkg/transport -type f -name '*.go') cmd/sidecar/*.go package/Dockerfile) | my_sha1sum | cut -c 1-8)${DIRTY}
    export CREDSYNCER_VERSION=$(get_version pkg/apis/refunc/v1beta3/*.go pkg/credsyncer/*.go cmd/credsyncer/*.go package/Dockerfile)${DIRTY}
fi

IMAGE_REPO=${IMAGE_REPO:-refunc}
IMAGE_PREFIX="${IMAGE_PREFIX}"

export REFUNC_IMAGE="${IMAGE_REPO}/${IMAGE_PREFIX}refunc:${REFUNC_VERSION}"
export AGENT_IMAGE="${IMAGE_REPO}/${IMAGE_PREFIX}agent:${AGENT_VERSION}"
export LOADER_IMAGE="${IMAGE_REPO}/${IMAGE_PREFIX}loader:${LOADER_VERSION}"
export SIDECAR_IMAGE="${IMAGE_REPO}/${IMAGE_PREFIX}sidecar:${SIDECAR_VERSION}"
export CREDSYNCER_IMAGE="${IMAGE_REPO}/${IMAGE_PREFIX}credsyncer:${CREDSYNCER_VERSION}"
